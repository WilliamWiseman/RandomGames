<!DOCTYPE html>

<html>

<body>
    <style>
    	html {
        	height:100%;
        }
        
        body {
            text-align: center;
            background-color: rgb(99, 186, 99);
            height:100%;
        }

        .gameArea {
            text-align: center;
        }
        canvas {
            z-index: 1;
            background-color:white;
            border:2px solid black;
        }
        .entity {
            z-index: 3;
            position:absolute;
            left:0;
            top:0;
        }
        .loader {
            display:none;
        }
        .button {
            display:none;
            z-index:2;
            position:absolute;
            left:0;
            top:0;
        }
    </style>
    
    <div id="add" class="gameArea"></div>
    <img id="boss" src="https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/WillBoss.gif">
    <img id="bar" src="https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/HealthBar.gif">
    <img id="name"src="https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/William.gif">
    <div id="health"></div>
    <canvas id="game" width="500" height="500"></canvas>
    <img src="https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/WillBoss.gif" class="loader">
    <img src="https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/WillBossHurt.gif" class="loader">
    <img src="https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/HurtButton.gif" class="loader">
    <img src="https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/HurtButtonPress.gif" class="loader">
    <img src="https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/Heart.gif" class="loader">
    
    
    <script>
        const pixelSize = window.innerHeight / 1000;
        const widthSize = window.innerWidth / 1000;
        let timer;
        let timer2;
        let timer3;
        let isDead = false;

        const canvas = document.getElementById("game");
        let boss = {
            img:document.getElementById('boss'),
            hp:10,
            bar:document.getElementById('health'),
            finished:0,
            hurt:function() {
                this.hp--;
                //play hurt sound
                this.img.src = "https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/WillBossHurt.gif";
                this.bar.style.width = `${pixelSize * (44 * boss.hp)}px`;
            }
        }
        boss.img.style = `position:absolute;z-index:2;width:${pixelSize * 500}px;height:${pixelSize * 300}px;left:${(window.innerWidth / 2) - (250 * pixelSize) + 2}px;top:0;filter: brightness(1.2);`;

        boss.bar.style = `position:absolute;z-index:1;background-color:blue;width:${pixelSize * (44 * boss.hp)}px;height:${pixelSize * 90}px;left:${(window.innerWidth / 2) - (220 * pixelSize)}px;top:${815 * pixelSize}px;`;

        let bar = document.getElementById('bar');
        bar.style = `position:absolute;z-index:1;width:${pixelSize * 500}px;height:${pixelSize * 120}px;left:${(window.innerWidth / 2) - (250 * pixelSize)}px;top:${800 * pixelSize}px;`;

        let name = document.getElementById('name');
        name.style = `position:absolute;z-index:3;width:${pixelSize * 500}px;height:${pixelSize * 120}px;left:${(window.innerWidth / 2) - (250 * pixelSize)}px;top:${800 * pixelSize}px;`;

        canvas.style = `z-index: 1;background-color:white;border:3px solid black;position:absolute;width:${pixelSize * 500}px;height:${pixelSize * 500}px;`;
        canvas.style.left = ((window.innerWidth / 2) - (250 * pixelSize)) + "px";
        canvas.style.top = 300 * pixelSize + "px";
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        let attackArr = [];
    	let fps = 60; //how many times things move a second, not render
        let canMove = true;
        let player = {
            x:225,
            y:225,
            width:50,
            height:50,
            momX:0,
            momY:0,
            leftJet:false,
            rightJet:false,
            img:false
        };
        player.img = document.createElement('img');
        player.img.className = "entity";
        player.img.src = "https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/Heart.gif";
        player.img.style.top = `${(canvas.style.top.replace('px', '') * 1) + (player.y * pixelSize)}px`;
        player.img.style.left = `${(canvas.style.left.replace('px', '') * 1) + (player.x * pixelSize)}px`;
        player.img.style.width = `${player.width * pixelSize}px`;
        player.img.style.height = `${player.height * pixelSize}px`;
        document.body.appendChild(player.img);
        
        function hitbox(x, y, width, height) {
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            return this;
        }
        
        document.addEventListener("keydown", function (event) {
            event.preventDefault();
            let key = event.key;
            key = key.toLowerCase();
            switch (key) {
                case "a":
                    player.leftJet = true;
                    //check/change sprite
                    break;
                case "d":
                    player.rightJet = true;
                    //check/change sprite
                    break;
                case "arrowleft":
                    player.leftJet = true;
                    //check/change sprite
                    break;
                case "arrowright":
                    player.rightJet = true;
                    //check/change sprite
                    break;
            }
        });
        
        document.addEventListener("keyup", function (event) {
            event.preventDefault();
            let key = event.key;
            key = key.toLowerCase();
            switch (key) {
                case "a":
                    player.leftJet = false;
                    //check/change sprite
                    break;
                case "d":
                    player.rightJet = false;
                    //check/change sprite
                    break;
                case "arrowleft":
                    player.leftJet = false;
                    //check/change sprite
                    break;
                case "arrowright":
                    player.rightJet = false;
                    //check/change sprite
                    break;
            }
        });
        
        function collision(a, b) {
            return !(
                ((a.y + a.height) < (b.y)) || //checks if a is higher than b's y
                (a.y > (b.y + b.height)) || // checks if b is lower  than a's y
                ((a.x + a.width) < b.x) || // checks if a is more left than b 
                (a.x > (b.x + b.width))// checks if a is more right than b
            );
        };
        
        function getColor(x, y) {
            const imgdata = ctx.getImageData(x, y, 1, 1);
            const red = imgdata.data[0];
            return red;
        };
        
        function startGameLoop(){
        requestAnimationFrame(gameLoop);
        }

        function attack(frames, x, y, width, height, momX, momY, framesTill){
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            this.momX = momX;
            this.momY = momY;
            this.frames = frames;
            this.framesTill = framesTill;
            this.exist = true;
            attack.prototype.put = function(){
                if(this.framesTill > 0){
                    this.framesTill--;
                    ctx.fillStyle = "rgb(0, 255, 100)";
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }else if(this.exist){
                    ctx.fillStyle = "rgb(255, 0, 0)";
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    this.x += this.momX;
                    this.y += this.momY;
                    this.frames--;
                    if(this.frames == 0){
                        boss.finished++;
                        this.exist = false;
                    }
                }
                }
            }
        
        function die(){
        player.momX = 0;
        player.momY = 0;
        player.x = 225;
        player.y = 225;
        player.img.style.top = `${(canvas.style.top.replace('px', '') * 1) + (player.y * pixelSize)}px`;
        player.img.style.left = `${(canvas.style.left.replace('px', '') * 1) + (player.x * pixelSize)}px`;
        isDead = true;
        attackArr = [];
        btn.disappear();
        document.body.style.backgroundColor = "darkred";
        if(timer2){
        clearTimeout(timer2);
        }
        timer2 = setTimeout(() => {
        isDead = false;
        document.body.style.backgroundColor = "rgb(99, 186, 99)";
        }, 1000);
        }

        function hurtButton(){
            this.x = 0;
            this.y = 0;
            this.width = 60;
            this.height = 60;
            this.exist = false;
            //initialize the DOM object
                this.img = document.createElement('img');
                this.img.className = "button";
                this.img.src = "https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/HurtButton.gif";
                this.img.style.top = `${(canvas.style.top.replace('px', '') * 1) + (this.y * pixelSize)}px`;
                this.img.style.left = `${(canvas.style.left.replace('px', '') * 1) + (this.x * pixelSize)}px`;
                this.img.style.width = `${this.width * pixelSize}px`;
                this.img.style.height = `${this.height * pixelSize}px`;
            document.body.appendChild(this.img);
            //added to the DOM

            hurtButton.prototype.put = function(x, y) {
                this.x = x;
                this.y = y; //update position

                this.img.src = "https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/HurtButton.gif";
                this.img.style.display = "block";
                this.img.style.top = `${(canvas.style.top.replace('px', '') * 1) + (this.y * pixelSize)}px`;
                this.img.style.left = `${(canvas.style.left.replace('px', '') * 1) + (this.x * pixelSize)}px`;//change DOM

                this.exist = true; // makes it so it checks if it is colliding with player
            }

            hurtButton.prototype.press = function() {
                this.img.src = "https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/HurtButtonPress.gif";
                //play click sound
                boss.hurt();
                this.exist = false;
                if(timer3){
                    clearTimeout(timer3);
                }
                timer3 = setTimeout(() => {
                    this.img.style.display = "none";
                    boss.img.src = "https://raw.githubusercontent.com/WilliamWiseman/RandomGames/main/images/WillBoss.gif";
                }, 1000);

            }

            hurtButton.prototype.disappear = function() {
                this.img.style.display = "none";
                this.exist = false;
            }
        }

        let btn = new hurtButton();

        boss.attacks = {
            center: function (){
                attackArr.push(new attack(160, 0, 0, 500, 10, 0, 1, 20));
                attackArr.push(new attack(160, 490, 0, 10, 500, -1, 0, 20));
                attackArr.push(new attack(160, 0, 0, 10, 500, 1, 0, 20));
                attackArr.push(new attack(160, 0, 490, 500, 10, 0, -1, 20));
            },
            left: function (){
                attackArr.push(new attack(40, 0, 0, 250, 500, 0, 0, 30));
            },
            right: function (){
                attackArr.push(new attack(40, 250, 0, 250, 500, 0, 0, 30));
            },
            freeDMG: function (){
                btn.put(400, 50);
            }
        }
        
        boss.attacks.freeDMG();

        function gameLoop(){
        
        if (canMove && !isDead) {
            player.momY++;//Gravity exists, no?

            if(player.leftJet){
                player.momX+=1;
                player.momY-=1.5;
            }
            if(player.rightJet){
                player.momX-=1;
                player.momY-=1.5;
            }
            player.momX = Math.floor(player.momX);
            if(player.momX > 15){  //We NEED a speed limit
                player.momX = 15;
            }else if(player.momX < -15){
                player.momX = -15;
            }
            player.momY = Math.floor(player.momY);
            if(player.momY > 15){  //We NEED a speed limit
                player.momY = 15;
            }else if(player.momY < -10){
                player.momY = -10;
            }

            //player.momX = Math.floor(player.momX - (player.momX / 5)); //Air resistance? quite choppy atm
            if(btn.exist){
                if(collision(btn, player)){
                    btn.press();
                }
            }
                player.x += player.momX;
                if (
                    getColor(player.x, player.y) !== 0 ||
                    getColor(player.x + player.width -1, player.y) !== 0 ||
                    getColor(player.x, player.y + player.height -1) !== 0 ||
                    getColor(player.x + player.width -1, player.y + player.height -1) !== 0 ||
                    player.x < 0 ||
                    player.x + player.width > canvas.width
                ) {
                    die();
                }
                player.y += player.momY;
                if (
                    getColor(player.x, player.y) !== 0 ||
                    getColor(player.x + player.width -1, player.y) !== 0 ||
                    getColor(player.x, player.y + player.height -1) !== 0 ||
                    getColor(player.x + player.width -1, player.y + player.height -1) !== 0 ||
                    player.y < 0 ||
                    player.y + player.height > canvas.height
                ) {
                    die();
                }

                //attacks to deal with
                    ctx.clearRect(0, 0, 500, 500);
                    let newArr = []; //builds new array
                for(let i = 0; i < attackArr.length; i++){
                    attackArr[i].put();//this is the function that puts the attack on screen an subtracts frames

                    if(attackArr[i].exist){
                        newArr.push(attackArr[i]); //this adds relevant frames to the new array
                    }

                }
                attackArr = newArr; //finally, we change the attackArr to the new array. No irrelevant or non-existant attacks!

                canMove = false;
                if(timer){
                    clearTimeout(timer);
                }
                timer = setTimeout(() => {
                    canMove = true;
                }, 1000 / fps);
        player.img.style.top = `${(canvas.style.top.replace('px', '') * 1) + (player.y * pixelSize)}px`;
        player.img.style.left = `${(canvas.style.left.replace('px', '') * 1) + (player.x * pixelSize)}px`;
            }
            requestAnimationFrame(gameLoop);
        };

        requestAnimationFrame(gameLoop);

        
    </script>

</body>

</html>
